# AmityVox Docker Compose — full stack deployment.
# Includes all required services: AmityVox core, PostgreSQL, NATS, DragonflyDB,
# Garage (S3), LiveKit, Meilisearch, and Caddy reverse proxy.
#
# Usage:
#   cp .env.example .env   # Edit with your settings
#   make docker-up         # Start all services
#   make docker-down       # Stop all services

services:
  # ============================================================
  # AmityVox Core Server
  # ============================================================
  amityvox:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
    container_name: amityvox
    restart: unless-stopped
    ports:
      - "8080:8080"
      - "8081:8081"
    env_file:
      - ../../.env
    environment:
      AMITYVOX_DATABASE_URL: "postgres://${POSTGRES_USER:-amityvox}:${POSTGRES_PASSWORD:-amityvox}@postgresql:5432/${POSTGRES_DB:-amityvox}?sslmode=disable"
      AMITYVOX_NATS_URL: "nats://nats:4222"
      AMITYVOX_CACHE_URL: "redis://dragonflydb:6379"
      AMITYVOX_STORAGE_ENDPOINT: "http://garage:3900"
      AMITYVOX_STORAGE_BUCKET: "${AMITYVOX_STORAGE_BUCKET:-amityvox}"
      AMITYVOX_STORAGE_REGION: "garage"
      AMITYVOX_LIVEKIT_URL: "ws://livekit:7880"
      AMITYVOX_LIVEKIT_API_KEY: "${LIVEKIT_API_KEY:-devkey}"
      AMITYVOX_LIVEKIT_API_SECRET: "${LIVEKIT_API_SECRET:-secret}"
      AMITYVOX_SEARCH_URL: "http://meilisearch:7700"
      AMITYVOX_SEARCH_API_KEY: "${MEILI_MASTER_KEY:-}"
      AMITYVOX_HTTP_LISTEN: "0.0.0.0:8080"
      AMITYVOX_WEBSOCKET_LISTEN: "0.0.0.0:8081"
      AMITYVOX_LOGGING_LEVEL: "${AMITYVOX_LOGGING_LEVEL:-info}"
      AMITYVOX_LOGGING_FORMAT: "${AMITYVOX_LOGGING_FORMAT:-json}"
      AMITYVOX_AUTH_WEBAUTHN_RP_DISPLAY_NAME: "${AMITYVOX_INSTANCE_NAME:-AmityVox}"
      AMITYVOX_AUTH_WEBAUTHN_RP_ID: "${AMITYVOX_INSTANCE_DOMAIN:-localhost}"
      AMITYVOX_AUTH_WEBAUTHN_RP_ORIGINS: "https://${AMITYVOX_INSTANCE_DOMAIN:-localhost}"
    depends_on:
      postgresql:
        condition: service_healthy
      nats:
        condition: service_started
      dragonflydb:
        condition: service_healthy
    networks:
      - amityvox

  # ============================================================
  # PostgreSQL — primary data store
  # ============================================================
  postgresql:
    image: postgres:18-alpine
    container_name: amityvox-postgresql
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-amityvox}
      POSTGRES_USER: ${POSTGRES_USER:-amityvox}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-amityvox}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-amityvox} -d ${POSTGRES_DB:-amityvox}"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - amityvox

  # ============================================================
  # NATS — message broker with JetStream
  # ============================================================
  nats:
    image: nats:2-alpine
    container_name: amityvox-nats
    restart: unless-stopped
    command: ["--jetstream", "--store_dir", "/data", "--http_port", "8222"]
    volumes:
      - nats_data:/data
    ports:
      - "4222:4222"
      - "8222:8222"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8222/healthz"]
      interval: 30s
      timeout: 5s
      retries: 3
    networks:
      - amityvox

  # ============================================================
  # DragonflyDB — cache and sessions (Redis-compatible)
  # ============================================================
  dragonflydb:
    image: docker.dragonflydb.io/dragonflydb/dragonfly:latest
    container_name: amityvox-dragonflydb
    restart: unless-stopped
    volumes:
      - dragonfly_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - amityvox

  # ============================================================
  # Garage — S3-compatible file storage
  # ============================================================
  garage:
    image: dxflrs/garage:v1.0.1
    container_name: amityvox-garage
    restart: unless-stopped
    volumes:
      - garage_data:/var/lib/garage/data
      - garage_meta:/var/lib/garage/meta
      - ../../deploy/garage/garage.toml:/etc/garage.toml:ro
    ports:
      - "3900:3900"
      - "3902:3902"
    environment:
      GARAGE_ALLOW_WORLD_READABLE_TMPDIR: "true"
    networks:
      - amityvox

  # ============================================================
  # LiveKit — voice and video (WebRTC SFU)
  # ============================================================
  livekit:
    image: livekit/livekit-server:latest
    container_name: amityvox-livekit
    restart: unless-stopped
    ports:
      - "7880:7880"
      - "7881:7881"
      - "7882:7882/udp"
    environment:
      LIVEKIT_KEYS: "${LIVEKIT_API_KEY:-devkey}: ${LIVEKIT_API_SECRET:-secret}"
    networks:
      - amityvox

  # ============================================================
  # Meilisearch — full-text search
  # ============================================================
  meilisearch:
    image: getmeili/meilisearch:v1.35
    container_name: amityvox-meilisearch
    restart: unless-stopped
    volumes:
      - meili_data:/meili_data
    ports:
      - "7700:7700"
    environment:
      MEILI_ENV: development
      MEILI_MASTER_KEY: ${MEILI_MASTER_KEY:-}
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:7700/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    networks:
      - amityvox

  # ============================================================
  # Caddy — reverse proxy with auto-TLS
  # ============================================================
  caddy:
    image: caddy:2-alpine
    container_name: amityvox-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ../../deploy/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - web_build:/srv:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      amityvox:
        condition: service_started
      web-init:
        condition: service_completed_successfully
    networks:
      - amityvox

  # ============================================================
  # Web Init — copies frontend build to shared volume for Caddy
  # ============================================================
  web-init:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
      target: frontend
    container_name: amityvox-web-init
    entrypoint: ["sh", "-c", "cp -r /web/build/* /srv/"]
    volumes:
      - web_build:/srv
    networks:
      - amityvox

  # ============================================================
  # Frontend Test Runner (on-demand)
  # Usage: docker compose -f deploy/docker/docker-compose.yml run --rm test-frontend
  # ============================================================
  test-frontend:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile.test
    container_name: amityvox-test-frontend
    working_dir: /app
    command: ["npm", "run", "test"]
    profiles:
      - test
    networks:
      - amityvox

volumes:
  web_build:
  postgres_data:
  nats_data:
  dragonfly_data:
  garage_data:
  garage_meta:
  meili_data:
  caddy_data:
  caddy_config:

networks:
  amityvox:
    driver: bridge
