# WebSocket Event Parity Report

*Generated by Phase 3B audit -- 2026-02-18*

## Overview

This report maps every event type published by the AmityVox backend through NATS
to whether it reaches the frontend via the WebSocket gateway and whether the
frontend handles it. The gateway subscribes to `amityvox.>` (wildcard) and uses
`shouldDispatchTo` to filter events per client based on guild membership, DM
participation, and friendship.

**Summary:**
- Total distinct event types published by backend: **49**
- Event types the gateway can dispatch: **46** (3 are backend-internal only)
- Event types the frontend handles: **29** (including 3 client-local lifecycle events)
- Event types with no frontend handler: **20** (missed real-time updates)

---

## WebSocket Event Coverage

| # | Backend Event Type | NATS Subject | Gateway Dispatches? | Frontend Handles? | Store Updated? | Status |
|---|---|---|---|---|---|---|
| 1 | `READY` | *client-local* | N/A (gateway sends on identify) | Yes | auth, guilds, DMs, unreads, relationships, presence, voice, muting | OK |
| 2 | `GATEWAY_DISCONNECTED` | *client-local* | N/A (frontend synthetic) | Yes | gatewayConnected, toast | OK |
| 3 | `GATEWAY_AUTH_FAILED` | *client-local* | N/A (frontend synthetic) | Yes | redirects to /login | OK |
| 4 | `GATEWAY_EXHAUSTED` | *client-local* | N/A (frontend synthetic) | Yes | gatewayConnected | OK |
| 5 | `MESSAGE_CREATE` | `amityvox.message.create` | Yes (guild/DM check) | Yes | messages, channels, unreads, notifications | OK |
| 6 | `MESSAGE_UPDATE` | `amityvox.message.update` | Yes (guild/DM check) | Yes | messages | OK |
| 7 | `MESSAGE_DELETE` | `amityvox.message.delete` | Yes (guild/DM check) | Yes | messages | OK |
| 8 | `MESSAGE_DELETE_BULK` | `amityvox.message.delete_bulk` | Yes (guild/DM check) | Yes | messages | OK |
| 9 | `MESSAGE_REACTION_ADD` | `amityvox.message.reaction_add` | Yes (guild/DM check) | **No** | -- | **MISSING** |
| 10 | `MESSAGE_REACTION_REMOVE` | `amityvox.message.reaction_remove` | Yes (guild/DM check) | **No** | -- | **MISSING** |
| 11 | `MESSAGE_EMBED_UPDATE` | `amityvox.message.embed_update` | Yes (guild/DM check) | **No** | -- | **MISSING** |
| 12 | `CHANNEL_CREATE` | `amityvox.channel.create` | Yes (guild/DM check) | Yes | channels, DMs | OK |
| 13 | `CHANNEL_UPDATE` | `amityvox.channel.update` | Yes (guild/DM check) | Yes | channels | OK |
| 14 | `CHANNEL_DELETE` | `amityvox.channel.delete` | Yes (guild/DM check) | Yes | channels, DMs | OK |
| 15 | `CHANNEL_PINS_UPDATE` | `amityvox.channel.pins_update` | Yes (channel check) | **No** | -- | **MISSING** |
| 16 | `TYPING_START` | `amityvox.channel.typing_start` | Yes (channel check) | Yes | typing | OK |
| 17 | `CHANNEL_ACK` | `amityvox.channel.ack` | Yes (channel check) | **No** | -- | **MISSING** |
| 18 | `THREAD_CREATE` | `amityvox.channel.create` (reuses subject) | Yes (guild check) | Yes | channels | OK |
| 19 | `GUILD_CREATE` | `amityvox.guild.create` | Yes (guild member check) | Yes | guilds, permissions | OK |
| 20 | `GUILD_UPDATE` | `amityvox.guild.update` | Yes (guild member check) | Yes | guilds, permissions | OK |
| 21 | `GUILD_DELETE` | `amityvox.guild.delete` | Yes (guild member check) | Yes | guilds, permissions | OK |
| 22 | `GUILD_MEMBER_ADD` | `amityvox.guild.member_add` | Yes (guild member check) | **No** | -- | **MISSING** |
| 23 | `GUILD_MEMBER_UPDATE` | `amityvox.guild.member_update` | Yes (guild member check) | Yes | members, permissions | OK |
| 24 | `GUILD_MEMBER_REMOVE` | `amityvox.guild.member_remove` | Yes (guild member check) | **No** | -- | **MISSING** |
| 25 | `GUILD_MEMBERS_PRUNE` | `amityvox.guild.member_remove` (reuses subject) | Yes (guild member check) | **No** | -- | **MISSING** |
| 26 | `GUILD_ROLE_CREATE` | `amityvox.guild.role_create` | Yes (guild member check) | **No** | -- | **MISSING** |
| 27 | `GUILD_ROLE_UPDATE` | `amityvox.guild.role_update` | Yes (guild member check) | Yes | permissions | OK |
| 28 | `GUILD_ROLE_DELETE` | `amityvox.guild.role_delete` | Yes (guild member check) | Yes | permissions | OK |
| 29 | `GUILD_BAN_ADD` | `amityvox.guild.ban_add` | Yes (guild member check) | **No** | -- | **MISSING** |
| 30 | `GUILD_BAN_REMOVE` | `amityvox.guild.ban_remove` | Yes (guild member check) | **No** | -- | **MISSING** |
| 31 | `GUILD_EMOJI_UPDATE` | `amityvox.guild.emoji_update` | Yes (guild member check) | **No** | -- | **MISSING** |
| 32 | `GUILD_EMOJI_DELETE` | `amityvox.guild.emoji_update` (reuses subject) | Yes (guild member check) | **No** | -- | **MISSING** |
| 33 | `GUILD_ONBOARDING_UPDATE` | `amityvox.guild.update` (reuses subject) | Yes (guild member check) | **No** | -- | **MISSING** |
| 34 | `PRESENCE_UPDATE` | `amityvox.presence.update` | Yes (shared guild/friend) | Yes | presence | OK |
| 35 | `USER_UPDATE` | `amityvox.user.update` | Yes (shared guild/friend) | Yes | auth, members, DMs | OK |
| 36 | `RELATIONSHIP_ADD` | `amityvox.user.relationship_add` | Yes (user-targeted) | Yes | relationships, notifications | OK |
| 37 | `RELATIONSHIP_UPDATE` | `amityvox.user.relationship_update` | Yes (user-targeted) | Yes | relationships | OK |
| 38 | `RELATIONSHIP_REMOVE` | `amityvox.user.relationship_remove` | Yes (user-targeted) | Yes | relationships | OK |
| 39 | `VOICE_STATE_UPDATE` | `amityvox.voice.state_update` | Yes (guild check via data) | Yes | voice, callRing | OK |
| 40 | `VOICE_SERVER_UPDATE` | `amityvox.voice.server_update` | Yes (guild check via data) | **No** | -- | **MISSING** |
| 41 | `CALL_RING` | `amityvox.voice.call_ring` | Yes (DM recipient check) | Yes | callRing | OK |
| 42 | `AUTOMOD_ACTION` | `amityvox.automod.action` | **No** (no dispatch path) | **No** | -- | **DEAD** |
| 43 | `POLL_CREATE` | `amityvox.poll.create` | **No** (no dispatch path) | **No** | -- | **DEAD** |
| 44 | `POLL_VOTE` | `amityvox.poll.vote` | **No** (no dispatch path) | **No** | -- | **DEAD** |
| 45 | `POLL_CLOSE` | `amityvox.poll.close` | **No** (no dispatch path) | **No** | -- | **DEAD** |
| 46 | `GUILD_EVENT_CREATE` | `amityvox.guild.event_create` | Yes (guild member check) | **No** | -- | **MISSING** |
| 47 | `GUILD_EVENT_UPDATE` | `amityvox.guild.event_update` | Yes (guild member check) | **No** | -- | **MISSING** |
| 48 | `GUILD_EVENT_DELETE` | `amityvox.guild.event_delete` | Yes (guild member check) | **No** | -- | **MISSING** |
| 49 | `RAID_LOCKDOWN` | `amityvox.guild.raid_lockdown` | Yes (guild member check) | **No** | -- | **MISSING** |
| 50 | `ANNOUNCEMENT_CREATE` | `amityvox.announcement.create` | Yes (broadcast to all) | Yes | announcements | OK |
| 51 | `ANNOUNCEMENT_UPDATE` | `amityvox.announcement.update` | Yes (broadcast to all) | Yes | announcements | OK |
| 52 | `ANNOUNCEMENT_DELETE` | `amityvox.announcement.delete` | Yes (broadcast to all) | Yes | announcements | OK |
| 53 | `FEDERATION_RETRY` | `amityvox.federation.retry` | **No** (internal work queue) | **No** | -- | INTERNAL |

---

## Non-Standard Events (Inline NATS Subjects)

These events use ad-hoc NATS subjects rather than the constants defined in `events.go`.
The gateway wildcard `amityvox.>` picks them up, but dispatch depends on
`shouldDispatchTo` matching the subject prefix. Events on `amityvox.channel.*`
subjects pass through the channel-check dispatch path.

| # | Backend Event Type | NATS Subject (inline) | Gateway Dispatches? | Frontend Handles? | Status |
|---|---|---|---|---|---|
| 54 | `LOCATION_SHARE_CREATE` | `amityvox.channel.location_share` | Yes (channel check) | **No** | **MISSING** |
| 55 | `LOCATION_SHARE_UPDATE` | `amityvox.channel.location_share` | Yes (channel check) | **No** | **MISSING** |
| 56 | `LOCATION_SHARE_STOP` | `amityvox.channel.location_share` | Yes (channel check) | **No** | **MISSING** |
| 57 | `MESSAGE_EFFECT_CREATE` | `amityvox.message.effect` | Yes (guild/DM check) | **No** | **MISSING** |
| 58 | `SUPER_REACTION_ADD` | `amityvox.message.reaction_add` | Yes (guild/DM check) | **No** | **MISSING** |
| 59 | `WHITEBOARD_UPDATE` | `amityvox.channel.whiteboard_update` | Yes (channel check) | **No** | **MISSING** |
| 60 | `CODE_SNIPPET_CREATE` | `amityvox.channel.code_snippet` | Yes (channel check) | **No** | **MISSING** |
| 61 | `KANBAN_CARD_CREATE` | `amityvox.channel.kanban_update` | Yes (channel check) | **No** | **MISSING** |
| 62 | `KANBAN_CARD_MOVE` | `amityvox.channel.kanban_update` | Yes (channel check) | **No** | **MISSING** |
| 63 | `CHANNEL_WIDGET_CREATE` | `amityvox.channel.update` (reuses) | Yes (channel check) | **No** | **MISSING** |
| 64 | `CHANNEL_WIDGET_UPDATE` | `amityvox.channel.update` (reuses) | Yes (channel check) | **No** | **MISSING** |
| 65 | `CHANNEL_WIDGET_DELETE` | `amityvox.channel.update` (reuses) | Yes (channel check) | **No** | **MISSING** |
| 66 | `COMPONENT_INTERACTION` | `component_interaction` | **No** (not under `amityvox.>`) | **No** | **DEAD** |
| 67 | `BOT_PRESENCE_UPDATE` | `bot_presence_update` | **No** (not under `amityvox.>`) | **No** | **DEAD** |
| 68 | `ACTIVITY_SESSION_START` | `amityvox.channel.activity` | Yes (channel check) | **No** | **MISSING** |
| 69 | `ACTIVITY_PARTICIPANT_JOIN` | `amityvox.channel.activity` | Yes (channel check) | **No** | **MISSING** |
| 70 | `ACTIVITY_PARTICIPANT_LEAVE` | `amityvox.channel.activity` | Yes (channel check) | **No** | **MISSING** |
| 71 | `ACTIVITY_SESSION_END` | `amityvox.channel.activity` | Yes (channel check) | **No** | **MISSING** |
| 72 | `ACTIVITY_STATE_UPDATE` | `amityvox.channel.activity` | Yes (channel check) | **No** | **MISSING** |
| 73 | `GAME_SESSION_CREATE` | `amityvox.channel.game` | Yes (channel check) | **No** | **MISSING** |
| 74 | `GAME_PLAYER_JOIN` | `amityvox.channel.game` | Yes (channel check) | **No** | **MISSING** |
| 75 | `GAME_MOVE` | `amityvox.channel.game` | Yes (channel check) | **No** | **MISSING** |
| 76 | `WATCH_TOGETHER_START` | `amityvox.channel.activity` | Yes (channel check) | **No** | **MISSING** |
| 77 | `WATCH_TOGETHER_SYNC` | `amityvox.channel.activity` | Yes (channel check) | **No** | **MISSING** |
| 78 | `MUSIC_PARTY_START` | `amityvox.channel.activity` | Yes (channel check) | **No** | **MISSING** |
| 79 | `MUSIC_PARTY_QUEUE_ADD` | `amityvox.channel.activity` | Yes (channel check) | **No** | **MISSING** |
| 80 | `SOUNDBOARD_SOUND_CREATE` | `amityvox.guild.update` (reuses) | Yes (guild member check) | **No** | **MISSING** |
| 81 | `SOUNDBOARD_SOUND_DELETE` | `amityvox.guild.update` (reuses) | Yes (guild member check) | **No** | **MISSING** |
| 82 | `SOUNDBOARD_PLAY` | `amityvox.voice.state_update` (reuses) | Yes (guild check via data) | **No** | **MISSING** |
| 83 | `VOICE_BROADCAST_START` | `amityvox.voice.state_update` (reuses) | Yes (guild check via data) | **No** | **MISSING** |
| 84 | `VOICE_BROADCAST_END` | `amityvox.voice.state_update` (reuses) | Yes (guild check via data) | **No** | **MISSING** |
| 85 | `SCREEN_SHARE_START` | `amityvox.voice.state_update` (reuses) | Yes (guild check via data) | **No** | **MISSING** |
| 86 | `SCREEN_SHARE_END` | `amityvox.voice.state_update` (reuses) | Yes (guild check via data) | **No** | **MISSING** |
| 87 | `SCREEN_SHARE_UPDATE` | `amityvox.voice.state_update` (reuses) | Yes (guild check via data) | **No** | **MISSING** |

---

## Status Legend

| Status | Meaning |
|---|---|
| **OK** | Backend publishes, gateway dispatches, frontend handles and updates stores |
| **MISSING** | Backend publishes and gateway dispatches, but frontend has no handler -- event is silently dropped by the switch default |
| **DEAD** | Backend publishes but the event never reaches any client (wrong NATS subject prefix or no gateway dispatch path) |
| **INTERNAL** | Backend-only event, intentionally not dispatched to clients (e.g., federation work queue) |

---

## Categorized Gap Analysis

### Critical -- Core Feature Events with No Frontend Handler (7)

These are standard chat/guild events that users expect to see in real time.
Without handlers, the UI requires a manual refresh to reflect changes.

| Event | Impact |
|---|---|
| `MESSAGE_REACTION_ADD` | Reactions don't appear in real time; must reload channel |
| `MESSAGE_REACTION_REMOVE` | Removed reactions persist in UI until refresh |
| `MESSAGE_EMBED_UPDATE` | Link previews/embeds never populate after message send |
| `CHANNEL_PINS_UPDATE` | Pinned message indicators don't update live |
| `GUILD_MEMBER_ADD` | Member list doesn't show new joins in real time |
| `GUILD_MEMBER_REMOVE` | Departed members remain visible in member list |
| `GUILD_ROLE_CREATE` | New roles don't appear until page refresh |

### High -- Moderation/Admin Events with No Frontend Handler (5)

Moderators miss real-time signals for ban actions, emoji changes, and automod.

| Event | Impact |
|---|---|
| `GUILD_BAN_ADD` | No real-time ban notification to moderators |
| `GUILD_BAN_REMOVE` | No real-time unban notification |
| `GUILD_EMOJI_UPDATE` / `GUILD_EMOJI_DELETE` | Emoji picker stale until refresh |
| `RAID_LOCKDOWN` | Moderators not alerted to automatic raid lockdown |
| `AUTOMOD_ACTION` | Automod actions invisible (also DEAD -- no dispatch path) |

### High -- Voice/Soundboard Events with No Frontend Handler (6)

The frontend handles basic `VOICE_STATE_UPDATE` but not the specialized
sub-types that reuse its NATS subject.

| Event | Impact |
|---|---|
| `VOICE_SERVER_UPDATE` | Voice server migrations not communicated to client |
| `SOUNDBOARD_PLAY` | Soundboard effects not audible to other participants |
| `SOUNDBOARD_SOUND_CREATE/DELETE` | Soundboard library stale |
| `VOICE_BROADCAST_START/END` | Broadcast status not shown to listeners |
| `SCREEN_SHARE_START/END/UPDATE` | Screen share status not reflected in UI |

### Medium -- Guild Events/Polls/Read State (7)

| Event | Impact |
|---|---|
| `GUILD_EVENT_CREATE/UPDATE/DELETE` | Scheduled events panel stale |
| `GUILD_ONBOARDING_UPDATE` | Onboarding changes require refresh |
| `POLL_CREATE/VOTE/CLOSE` | Polls DEAD -- backend publishes to `amityvox.poll.*` but `shouldDispatchTo` has no handler for this prefix (falls through to deny) |
| `CHANNEL_ACK` | Read state acknowledgments from other sessions not synced |

### Low -- Experimental/Activity Features (24)

These are newer features with backend event publishing but no frontend consumers.
They represent future feature work rather than regressions.

| Category | Events | Count |
|---|---|---|
| Location sharing | `LOCATION_SHARE_CREATE/UPDATE/STOP` | 3 |
| Message effects | `MESSAGE_EFFECT_CREATE`, `SUPER_REACTION_ADD` | 2 |
| Collaborative tools | `WHITEBOARD_UPDATE`, `CODE_SNIPPET_CREATE`, `KANBAN_CARD_CREATE/MOVE` | 4 |
| Channel widgets | `CHANNEL_WIDGET_CREATE/UPDATE/DELETE` | 3 |
| Activities | `ACTIVITY_SESSION_START/END`, `ACTIVITY_PARTICIPANT_JOIN/LEAVE`, `ACTIVITY_STATE_UPDATE` | 5 |
| Games | `GAME_SESSION_CREATE`, `GAME_PLAYER_JOIN`, `GAME_MOVE` | 3 |
| Watch Together | `WATCH_TOGETHER_START/SYNC` | 2 |
| Music Party | `MUSIC_PARTY_START`, `MUSIC_PARTY_QUEUE_ADD` | 2 |

### Dead Events -- Never Reach Clients (6)

These events are published to NATS but can never reach any WebSocket client.

| Event | NATS Subject | Reason |
|---|---|---|
| `AUTOMOD_ACTION` | `amityvox.automod.action` | `shouldDispatchTo` has no path for `amityvox.automod.*` -- falls to default deny |
| `POLL_CREATE` | `amityvox.poll.create` | `shouldDispatchTo` has no path for `amityvox.poll.*` -- falls to default deny |
| `POLL_VOTE` | `amityvox.poll.vote` | Same as above |
| `POLL_CLOSE` | `amityvox.poll.close` | Same as above |
| `COMPONENT_INTERACTION` | `component_interaction` | Subject not under `amityvox.>` wildcard -- gateway never receives it |
| `BOT_PRESENCE_UPDATE` | `bot_presence_update` | Subject not under `amityvox.>` wildcard -- gateway never receives it |

**Fix for DEAD events:**
1. **Automod/Poll events**: Add dispatch paths in `shouldDispatchTo` for `amityvox.automod.*` and `amityvox.poll.*` subjects (extract guild_id from event data, dispatch to guild members).
2. **Bot events**: Change NATS subjects to `amityvox.bot.component_interaction` and `amityvox.bot.presence_update` so the gateway wildcard subscription picks them up. Alternatively, these may be intentionally bot-SDK-only (not meant for regular clients).

---

## Gateway Dispatch Path Coverage

The `shouldDispatchTo` function handles these subject prefixes:

| Subject Prefix | Dispatch Logic | Coverage |
|---|---|---|
| `amityvox.presence.*` | Shared-guild or friend check | OK |
| `amityvox.user.*` | User-targeted (relationships) or shared-guild | OK |
| `amityvox.guild.*` | Guild membership check (primary or via data.guild_id) | OK |
| `amityvox.voice.*` | Guild membership check via data.guild_id | OK |
| `amityvox.channel.*` | Channel guild lookup or DM recipient check | OK |
| `amityvox.message.*` | Falls through to channel_id check (guild or DM) | OK |
| `amityvox.announcement.*` | Broadcast to all identified clients | OK |
| `amityvox.automod.*` | **No path** -- falls to default deny | **GAP** |
| `amityvox.poll.*` | **No path** -- falls to default deny | **GAP** |
| `amityvox.federation.*` | Not in gateway wildcard scope (separate JetStream consumer) | INTERNAL |

---

## Recommendations

### P0 -- Fix Dead Event Dispatch (gateway bug)
1. Add `amityvox.automod.*` dispatch path: extract guild_id from event data, dispatch to guild members with moderation permissions.
2. Add `amityvox.poll.*` dispatch path: extract channel_id from event data, use channel-based guild/DM dispatch.
3. Move bot events to `amityvox.bot.*` namespace or document them as intentionally SDK-only.

### P1 -- Add Critical Frontend Handlers
4. `MESSAGE_REACTION_ADD` / `MESSAGE_REACTION_REMOVE`: Update message reaction counts in the messages store.
5. `MESSAGE_EMBED_UPDATE`: Merge new embed data into existing message in messages store.
6. `GUILD_MEMBER_ADD` / `GUILD_MEMBER_REMOVE`: Update member list store, show join/leave system messages.
7. `GUILD_ROLE_CREATE`: Add to roles store so role management UI stays current.
8. `CHANNEL_PINS_UPDATE`: Update pinned message indicator in channel store.

### P2 -- Add Moderation/Voice Handlers
9. `GUILD_BAN_ADD` / `GUILD_BAN_REMOVE`: Show toast notifications to moderators.
10. `GUILD_EMOJI_UPDATE` / `GUILD_EMOJI_DELETE`: Refresh emoji picker data.
11. `RAID_LOCKDOWN`: Show lockdown banner to moderators and affected members.
12. `VOICE_SERVER_UPDATE`: Handle voice server migrations.
13. `SCREEN_SHARE_START/END/UPDATE`: Update voice panel UI with screen share indicators.
14. `SOUNDBOARD_PLAY`: Trigger audio playback for soundboard effects.

### P3 -- Add Poll/Event/Read State Handlers
15. `POLL_CREATE` / `POLL_VOTE` / `POLL_CLOSE`: Update poll components in real time.
16. `GUILD_EVENT_CREATE/UPDATE/DELETE`: Update scheduled events panel.
17. `CHANNEL_ACK`: Sync read state across multiple sessions.

### P4 -- Experimental Feature Handlers (future work)
18. Activity, game, watch-together, music-party, location-sharing, whiteboard, kanban, code-snippet, and widget events -- implement frontend handlers as the corresponding UI features are built out.
